# 🍉 合成大西瓜 (Daxigua) - 核心机制白皮书

> 版本: v2.1 (Chaos Edition)
> 最后更新: 2026-02-04

本文档作为项目的**单一事实来源 (SSoT)**，详细定义了游戏的所有逻辑、参数配置、物理规则及交互机制。

---

## 1. 游戏概览

### 核心玩法
基于物理引擎的 2D 掉落合并游戏。玩家控制水果的投放位置，相同等级的水果碰撞后合成为更高一级的水果，直到合成“大西瓜”。

### 胜利与失败
- **得分**: 每次合成获得分数，连击 (Combo) 可获得倍率加成。
- **失败**: 当水果堆叠高度超过警戒线（屏幕顶部 18% 处）且保持静止时，游戏结束。
- **胜利**: 合成第 11 级水果（大西瓜）视为阶段性胜利，可继续挑战高分。

---

## 2. 物理系统 (Physics)

游戏使用自定义的轻量级 2D 物理引擎，基于冲量 (Impulse) 和位置修正 (Position Correction) 机制。

### 2.1 全局参数
| 参数 | 值 | 说明 |
|------|----|------|
| **重力 (Gravity)** | `(0, 1.2)` | 垂直向下的恒定加速度。 |
| **空气阻力** | `0.02` | 每帧速度衰减 `vel *= (1 - 0.02)`。 |
| **速度阻尼** | `0.98` | 额外的全局速度衰减。 |
| **休眠阈值** | `speed < 0.5` | 物体速度极低持续 30 帧后进入休眠 (Sleeping)，停止物理计算以节省性能。 |

### 2.2 材质属性
不同水果拥有不同的物理材质，影响手感：
- **弹性 (Restitution)**: 决定反弹力度。葡萄 (0.15) 比番茄 (0.05) 更弹。
- **摩擦力 (Friction)**: 决定滑动阻力。菠萝 (0.55) 表面粗糙，不易滑动；樱桃 (0.20) 表面光滑。

### 2.3 碰撞处理
- **检测**: 圆形与圆形（水果间）、圆形与矩形（墙壁/地面）。
- **响应**: 
  1. **位置修正**: 将重叠的物体推开，避免穿模。
  2. **冲量传递**: 根据质量比交换动量。
  3. **摩擦应用**: 切向速度衰减。

---

## 3. 混沌模式 (Chaos Mode) - v2.1 新增

为了增加游戏的变数和策略性，引入了“混沌”机制。

### 3.1 呼吸墙 (Living Jar)
- **机制**: 游戏容器的左右墙壁不再静止，而是进行周期性的水平移动。
- **公式**: `offset = sin(time / 5000) * 15px`
- **影响**: 周期为 5 秒，幅度 15px。这会导致原本卡住的水果松动，或改变堆叠结构的稳定性。

### 3.2 切水果 (Fruit Slice)
- **交互**: 玩家可以在水果**下落过程中**（未触地前）滑动屏幕切开水果。
- **判定**: 
  - 水果必须处于空中 (`y < groundY - 2r`)。
  - 手指划过的线段与水果圆形相交。
- **效果**: 
  - 销毁原水果。
  - 生成两个**低一级**的小水果。
  - 赋予两个小水果向外的水平速度 `(±200, -100)`。
- **策略**: 牺牲高分水果，换取更小的体积，避免堆叠过高导致游戏结束。

### 3.3 Roguelike 神器系统
- **触发**: 每获得 **500分**，游戏暂停，弹出“神器/Buff”选择面板（三选一）。
- **目的**: 鼓励玩家构建独特的流派（如“重力流”、“穿透流”）。

---

## 4. 实体系统 (Entities)

### 4.1 水果 (Fruits)
共 11 个等级，半径从 26px 到 115px 递增。

### 4.2 特殊实体
| 实体 | 出现概率 | 行为逻辑 |
|------|----------|----------|
| **盲盒 (Mystery Box)** | 5% | 落地 0.5秒后揭示。可能变为：进化(+3级)、炸弹、或随机低级水果。 |
| **冰封果实 (Ice Block)** | 8% | 无法合成。需在附近发生合成或爆炸产生的冲击波来解冻。支持连锁解冻。 |
| **炸弹 (Bomb)** | 道具/盲盒 | 3秒倒计时后爆炸。销毁半径 90px 内的物体，推开 180px 内的物体。 |
| **引力场 (Gravity Field)** | 2% | 持续 8秒。将 150px 范围内的水果吸向中心。中心吸力倍率 2.0。 |

---

## 5. 技能与道具 (Skills & Tools)

### 5.1 主动技能 (Cooldown Based)
位于工具栏，无消耗，仅受冷却时间限制。

- **📳 震动 (Shake)**
  - **冷却**: 10秒
  - **效果**: 对所有水果施加一个向上的随机冲量 `(rand±2, -10)`。模拟地震效果，用于重新排列堆叠。
  
- **💨 吹风 (Gust)**
  - **冷却**: 15秒
  - **效果**: 对所有水果施加较强的向上气流 `(rand±2.5, -15)`。配合“大风”天气特效。

### 5.2 消耗型道具
- **🔨 锤子**: 销毁任意一个点击的水果。
- **🍇 选果**: 指定下一个生成的水果类型。
- **⏭️ 跳过**: 直接丢弃当前水果，生成下一个。

---

## 6. 环境系统 (Environment)

### 6.1 天气 (Weather)
每 30 秒判定一次，持续 15 秒。
- **🌪️ 大风**: 施加持续的水平力 `F_x = 0.3`。
- **🌧️ 梅雨**: 全局摩擦力降至 `0.01`（极滑）。
- **❄️ 霜冻**: 全局弹性系数降至 `0.01`（无反弹）。
- **🔮 反重力**: 重力反转 `G_y = -0.36`，水果缓慢上浮。结束后有 1.5秒 保护期不检测死亡。

### 6.2 地震 (Earthquake)
- **触发**: 当有水果超过警戒线持续 1.5秒时自动触发。
- **效果**: 强力向上震动，试图挽救死局。冷却时间 8秒。

---

## 7. 连击与狂热 (Combo & Fever)

### Combo
- **判定窗口**: 1.5秒。在此时间内连续合成，Combo 数 +1。
- **收益**: 分数倍率 `Score = Base * (1 + (Combo-1)*0.5)`。
- **反馈**: 随着 Combo 增加，合成音效的音调 (Pitch) 升高，画面饱和度增加。

### Fever Mode
- **触发**: Combo 达到 5。
- **持续**: 6秒。
- **效果**: 
  1. 所有水果半径缩小 15%（更容易掉落缝隙）。
  2. 投放冷却时间归零（无限火力）。
  3. 背景变为橙色脉冲动画。

---

## 8. Buff 系统详解

| Buff ID | 名称 | 叠加 | 效果逻辑 |
|---------|------|------|----------|
| `expand` | 扩容 | Max 5 | 容器左右墙壁各向外移动 5px。 |
| `soften` | 软化 | Max 3 | 全局重力系数 `G *= 0.85`。 |
| `precision`| 精准 | 否 | 显示水果下落的预测轨迹线（考虑风力）。 |
| `piercing` | 穿透弹 | Max 3 | 下次投放的水果在碰到第一个物体时不会停止，而是直接销毁该物体（穿透）。 |
| `vaporize` | 蒸发 | 即时 | 立即消除场上所有 0-2 级（葡萄/樱桃/橘子）的小水果。 |
| `shuffle` | 洗牌 | 即时 | 将场上所有水果的位置随机交换。 |

---

## 9. 平台差异

### 微信小程序
- 使用 `wx.createCanvas`。
- 使用 `wx.getStorageSync` 存取数据。
- 支持 `wx.shareAppMessage` 分享。
- 支持 `wx.getOpenDataContext` 开放数据域排行榜。

### Web 浏览器
- 使用标准 DOM `canvas`。
- 使用 `localStorage`。
- 调试模式下支持键盘快捷键。

---

## 10. 调试系统 (Debug)

仅在 `__DEV__ = true` 时可用。
- **面板**: 可视化触发所有天气、生成特殊实体、添加道具。
- **开关**: 可实时开启/关闭 呼吸墙、切水果、天气系统等。
- **状态**: 实时监控刚体数量、Combo 数、Fever 状态。
